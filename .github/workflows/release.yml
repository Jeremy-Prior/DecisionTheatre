name: Release

on:
  push:
    tags: ['v*']

permissions:
  contents: write

jobs:
  # ==========================================
  # Build platform-specific binaries
  # ==========================================
  build:
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            goos: linux
            goarch: amd64
            suffix: linux-amd64
          - os: ubuntu-24.04-arm
            goos: linux
            goarch: arm64
            suffix: linux-arm64
          - os: macos-13
            goos: darwin
            goarch: amd64
            suffix: darwin-amd64
          - os: macos-14
            goos: darwin
            goarch: arm64
            suffix: darwin-arm64
          - os: windows-latest
            goos: windows
            goarch: amd64
            suffix: windows-amd64

    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      # --- Build frontend (all platforms) ---
      - name: Build frontend
        run: |
          cd frontend
          npm ci
          npm run build

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Build documentation
        run: |
          pip install mkdocs mkdocs-material mkdocs-minify-plugin pygments pymdown-extensions
          mkdocs build -d internal/server/docs_site

      - name: Copy frontend to embed dir (unix)
        if: runner.os != 'Windows'
        run: |
          rm -rf internal/server/static
          mkdir -p internal/server/static
          cp -r frontend/dist/* internal/server/static/

      - name: Copy frontend to embed dir (windows)
        if: runner.os == 'Windows'
        run: |
          Remove-Item -Recurse -Force internal\server\static -ErrorAction SilentlyContinue
          New-Item -ItemType Directory -Force internal\server\static
          Copy-Item -Recurse frontend\dist\* internal\server\static\

      # --- Install platform CGO dependencies ---
      - name: Install CGO deps (linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libopenblas-dev libwebkit2gtk-4.1-dev libgtk-3-dev

      - name: Install CGO deps (macOS)
        if: runner.os == 'macOS'
        run: brew install openblas

      # --- Build binary ---
      - name: Build binary (unix)
        if: runner.os != 'Windows'
        env:
          CGO_ENABLED: 1
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
        run: |
          mkdir -p dist
          go build -ldflags "-s -w -X main.version=${{ github.ref_name }}" \
            -o dist/decision-theatre .

      - name: Build binary (windows)
        if: runner.os == 'Windows'
        env:
          CGO_ENABLED: 1
        run: |
          mkdir dist
          go build -ldflags "-s -w -X main.version=${{ github.ref_name }}" -o dist/decision-theatre.exe .

      # --- Package ---
      - name: Package (unix)
        if: runner.os != 'Windows'
        run: |
          cd dist
          tar -czf decision-theatre-${{ matrix.suffix }}.tar.gz decision-theatre
          sha256sum *.tar.gz > checksums-${{ matrix.suffix }}.txt

      - name: Package (windows)
        if: runner.os == 'Windows'
        run: |
          cd dist
          Compress-Archive -Path decision-theatre.exe -DestinationPath decision-theatre-${{ matrix.suffix }}.zip
          $hash = (Get-FileHash decision-theatre-${{ matrix.suffix }}.zip -Algorithm SHA256).Hash.ToLower()
          "$hash  decision-theatre-${{ matrix.suffix }}.zip" | Out-File -Encoding utf8 checksums-${{ matrix.suffix }}.txt

      - uses: actions/upload-artifact@v4
        with:
          name: release-${{ matrix.suffix }}
          path: |
            dist/*.tar.gz
            dist/*.zip

      - uses: actions/upload-artifact@v4
        with:
          name: checksums-${{ matrix.suffix }}
          path: dist/checksums-*.txt

      # Upload raw binary for packaging jobs
      - uses: actions/upload-artifact@v4
        if: runner.os != 'Windows'
        with:
          name: binary-${{ matrix.suffix }}
          path: dist/decision-theatre

  # ==========================================
  # Linux: DEB and RPM via nfpm
  # ==========================================
  package-linux-nfpm:
    needs: build
    strategy:
      matrix:
        include:
          - suffix: linux-amd64
            goarch: amd64
          - suffix: linux-arm64
            goarch: arm64
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: binary-${{ matrix.suffix }}
          path: dist

      - name: Make binary executable
        run: chmod +x dist/decision-theatre

      - name: Install nfpm
        run: |
          echo 'deb [trusted=yes] https://repo.goreleaser.com/apt/ /' | sudo tee /etc/apt/sources.list.d/goreleaser.list
          sudo apt-get update
          sudo apt-get install -y nfpm

      - name: Build DEB
        env:
          VERSION: ${{ github.ref_name }}
          GOARCH: ${{ matrix.goarch }}
        run: |
          VERSION="${VERSION#v}"
          nfpm package -p deb -f packaging/nfpm.yaml -t dist/

      - name: Build RPM
        env:
          VERSION: ${{ github.ref_name }}
          GOARCH: ${{ matrix.goarch }}
        run: |
          VERSION="${VERSION#v}"
          nfpm package -p rpm -f packaging/nfpm.yaml -t dist/

      - uses: actions/upload-artifact@v4
        with:
          name: packages-nfpm-${{ matrix.suffix }}
          path: |
            dist/*.deb
            dist/*.rpm

  # ==========================================
  # Linux: AppImage
  # ==========================================
  package-appimage:
    needs: build
    strategy:
      matrix:
        include:
          - suffix: linux-amd64
            arch: x86_64
          - suffix: linux-arm64
            arch: aarch64
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: binary-${{ matrix.suffix }}
          path: dist

      - name: Make binary executable
        run: chmod +x dist/decision-theatre

      - name: Build AppImage
        run: |
          # Download appimagetool
          wget -q "https://github.com/AppImage/appimagetool/releases/download/continuous/appimagetool-x86_64.AppImage" -O appimagetool
          chmod +x appimagetool

          # Create AppDir
          mkdir -p AppDir/usr/bin
          cp dist/decision-theatre AppDir/usr/bin/
          cp packaging/appimage/AppRun AppDir/
          cp packaging/appimage/decision-theatre.desktop AppDir/
          # Placeholder icon (1x1 PNG)
          echo -n "" > AppDir/decision-theatre.png
          touch AppDir/decision-theatre.png

          # Build
          ARCH=${{ matrix.arch }} ./appimagetool --no-appstream AppDir/ \
            "dist/Decision_Theatre-${{ matrix.arch }}.AppImage"

      - uses: actions/upload-artifact@v4
        with:
          name: packages-appimage-${{ matrix.suffix }}
          path: dist/*.AppImage

  # ==========================================
  # Linux: Flatpak
  # ==========================================
  package-flatpak:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: binary-linux-amd64
          path: dist

      - name: Make binary executable
        run: chmod +x dist/decision-theatre

      - name: Install Flatpak tools
        run: |
          sudo apt-get update
          sudo apt-get install -y flatpak flatpak-builder
          flatpak remote-add --user --if-not-exists flathub https://dl.flathub.org/repo/flathub.flatpakrepo
          flatpak install --user -y flathub org.gnome.Platform//46 org.gnome.Sdk//46

      - name: Build Flatpak
        run: |
          cp dist/decision-theatre packaging/flatpak/
          cp packaging/decision-theatre.desktop packaging/flatpak/
          cd packaging/flatpak
          flatpak-builder --user --force-clean --repo=repo build org.kartoza.DecisionTheatre.yml
          flatpak build-bundle repo ../../dist/decision-theatre.flatpak org.kartoza.DecisionTheatre

      - uses: actions/upload-artifact@v4
        with:
          name: packages-flatpak
          path: dist/*.flatpak

  # ==========================================
  # Linux: Snap
  # ==========================================
  package-snap:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: binary-linux-amd64
          path: packaging/snap

      - name: Make binary executable
        run: chmod +x packaging/snap/decision-theatre

      - uses: snapcore/action-build@v1
        id: snapcraft
        with:
          path: packaging/snap

      - uses: actions/upload-artifact@v4
        with:
          name: packages-snap
          path: ${{ steps.snapcraft.outputs.snap }}

  # ==========================================
  # macOS: .dmg Application Bundle
  # ==========================================
  package-macos:
    needs: build
    strategy:
      matrix:
        include:
          - suffix: darwin-amd64
            arch: amd64
            os: macos-13
          - suffix: darwin-arm64
            arch: arm64
            os: macos-14
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: binary-${{ matrix.suffix }}
          path: dist

      - name: Make binary executable
        run: chmod +x dist/decision-theatre

      - name: Create DMG
        run: |
          cd dist
          bash ../packaging/macos/create-dmg.sh \
            decision-theatre \
            "${{ github.ref_name }}" \
            "${{ matrix.arch }}"

      - uses: actions/upload-artifact@v4
        with:
          name: packages-macos-${{ matrix.suffix }}
          path: dist/*.dmg

  # ==========================================
  # Windows: MSI installer
  # ==========================================
  package-windows:
    needs: build
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: release-windows-amd64
          path: dist

      - name: Extract binary
        run: |
          Expand-Archive -Path dist\decision-theatre-windows-amd64.zip -DestinationPath dist\

      - name: Install WiX
        run: dotnet tool install --global wix

      - name: Build MSI
        run: |
          $version = "${{ github.ref_name }}".TrimStart("v")
          # Ensure 3-part version for MSI
          $parts = $version.Split(".")
          while ($parts.Length -lt 3) { $parts += "0" }
          $msiVersion = ($parts[0..2]) -join "."
          wix build packaging\windows\product.wxs -d Version=$msiVersion -o dist\decision-theatre-windows-amd64.msi

      - uses: actions/upload-artifact@v4
        with:
          name: packages-windows
          path: dist/*.msi

  # ==========================================
  # Publish GitHub release with all artifacts
  # ==========================================
  release:
    needs:
      - build
      - package-linux-nfpm
      - package-appimage
      - package-flatpak
      - package-snap
      - package-macos
      - package-windows
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          pattern: release-*
          merge-multiple: true
          path: release

      - uses: actions/download-artifact@v4
        with:
          pattern: checksums-*
          merge-multiple: true
          path: checksums

      - uses: actions/download-artifact@v4
        with:
          pattern: packages-*
          merge-multiple: true
          path: release

      - name: Merge checksums
        run: |
          cat checksums/checksums-*.txt | sort > release/checksums.txt
          # Add checksums for installers
          cd release
          sha256sum *.deb *.rpm *.AppImage *.flatpak *.snap *.dmg *.msi 2>/dev/null >> checksums.txt || true

      - uses: softprops/action-gh-release@v2
        with:
          files: release/*
          generate_release_notes: true
          body: |
            ## Installation

            ### Download the installer for your platform

            | Platform | Package | Notes |
            |----------|---------|-------|
            | **Ubuntu/Debian** | `.deb` | `sudo dpkg -i decision-theatre-*.deb` |
            | **Fedora/RHEL** | `.rpm` | `sudo rpm -i decision-theatre-*.rpm` |
            | **Any Linux** | `.AppImage` | `chmod +x *.AppImage && ./*.AppImage` |
            | **Flatpak** | `.flatpak` | `flatpak install decision-theatre.flatpak` |
            | **Snap** | `.snap` | `sudo snap install --dangerous *.snap` |
            | **NixOS** | Flake | `nix profile install github:kartoza/DecisionTheatre` |
            | **macOS** | `.dmg` | Open and drag to Applications |
            | **Windows** | `.msi` | Run the installer |

            ### Portable binaries (no installer)

            **Linux/macOS:**
            ```bash
            tar xzf decision-theatre-*.tar.gz
            ./decision-theatre
            ```

            **Windows:**
            Extract the zip, then run `decision-theatre.exe`.

            ### Data Pack

            The application requires a data pack to load map tiles and scenario data.
            On first launch, you'll be prompted to provide the path to a data pack (.zip).
            Contact the project maintainers to obtain the data pack.

            ### Headless mode (no GUI window)
            ```bash
            ./decision-theatre --headless
            ```
            Then open http://localhost:8080 in your browser.

            ### Requirements
            - **Linux:** WebKitGTK 4.1 (`libwebkit2gtk-4.1-0` on Debian/Ubuntu)
            - **macOS:** No extra dependencies
            - **Windows:** Edge WebView2 runtime (included in Windows 10+)
